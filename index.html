<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intrinsic Value Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    h1 { text-align: center; }
    input, button { margin: 8px 0; padding: 10px; width: 100%; }
    .scenarios { display: flex; gap: 20px; margin-top: 20px; }
    .output, .math, .extra { background: #fff; padding: 12px; border-radius: 6px; font-size: 14px; margin-top: 10px; flex: 1; }
    .math { font-family: monospace; background: #eee; white-space: pre-wrap; }
    .pessimistic { color: red; }
    .optimistic { color: green; }
  </style>
</head>
<body>
  <h1>üìä Intrinsic Value Calculator</h1>

  <label for="symbol">Stock Symbol:</label>
  <input type="text" id="symbol" placeholder="e.g., AMZN">

  <label for="growth">Estimated Annual Growth Rate (%):</label>
  <input type="number" id="growth" placeholder="e.g., 10">

  <label for="pe">Expected Future P/E Ratio:</label>
  <input type="number" id="pe" placeholder="e.g., 25">

  <label for="discount">Discount Rate (%):</label>
  <input type="number" id="discount" placeholder="e.g., 10">

  <button onclick="calculate()">Calculate</button>

  <div id="result" class="output"></div>
  <div class="scenarios">
    <div id="pessimistic" class="output pessimistic"></div>
    <div id="optimistic" class="output optimistic"></div>
  </div>
  <div id="extra" class="extra"></div>
  <div id="math" class="math"></div>

<script>
  const API_KEY = "d0kuab9r01qhb02558rgd0kuab9r01qhb02558s0";
  const years = 5;

  async function calculate() {
    const symbol = document.getElementById("symbol").value.toUpperCase();
    const userGrowthRate = parseFloat(document.getElementById("growth").value) / 100;
    const expectedPE = parseFloat(document.getElementById("pe").value);
    const discountRate = parseFloat(document.getElementById("discount").value) / 100;

    const resultDiv = document.getElementById("result");
    const pessimisticDiv = document.getElementById("pessimistic");
    const optimisticDiv = document.getElementById("optimistic");
    const extraDiv = document.getElementById("extra");
    const mathDiv = document.getElementById("math");

    try {
      const [profileRes, quoteRes, metricsRes] = await Promise.all([
        fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${API_KEY}`),
        fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`),
        fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${API_KEY}`)
      ]);

      const profile = await profileRes.json();
      const quote = await quoteRes.json();
      const metrics = await metricsRes.json();

      const eps = metrics.metric["epsTTM"] || 0;
      const price = quote.c || 0;
      const currentPE = eps > 0 ? (price / eps).toFixed(2) : "N/A";
      const normalizedPE = metrics.metric["peNormalizedAnnual5Y"] || "N/A";
      const revenueGrowth5Y = metrics.metric["revenueGrowth5Y"] || null;

      function calculateIntrinsic(eps, growthRate, peRatio, discountRate) {
        let intrinsicValue = 0;
        for (let t = 1; t <= years; t++) {
          const futureEPS = eps * Math.pow(1 + growthRate, t);
          const discounted = futureEPS / Math.pow(1 + discountRate, t);
          intrinsicValue += discounted;
        }
        const terminalEPS = eps * Math.pow(1 + growthRate, years);
        const terminalValue = terminalEPS * peRatio;
        const discountedTerminal = terminalValue / Math.pow(1 + discountRate, years);
        intrinsicValue += discountedTerminal;
        return { intrinsicValue };
      }

      const base = calculateIntrinsic(eps, userGrowthRate, expectedPE, discountRate);
      const pessimistic = calculateIntrinsic(eps, userGrowthRate - 0.02, expectedPE - 2, discountRate);
      const optimistic = calculateIntrinsic(eps, userGrowthRate + 0.02, expectedPE + 2, discountRate);

      const baseUpside = price > 0 ? ((base.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";
      const pessimisticUpside = price > 0 ? ((pessimistic.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";
      const optimisticUpside = price > 0 ? ((optimistic.intrinsicValue - price) / price * 100).toFixed(2) : "N/A";

      resultDiv.innerHTML = `
        <strong>${profile.name || symbol}</strong><br>
        EPS (TTM): $${eps.toFixed(2)}<br>
        Current Price: $${price.toFixed(2)}<br>
        Current P/E: ${currentPE}<br>
        Expected Future P/E: ${expectedPE} vs Normalized P/E (5Y): ${normalizedPE}<br>
        Estimated Growth Rate: ${(userGrowthRate * 100).toFixed(2)}% ${revenueGrowth5Y ? `vs Revenue Growth (5Y CAGR): ${(revenueGrowth5Y * 100).toFixed(2)}%` : ""}<br>
        Discount Rate: ${(discountRate * 100).toFixed(2)}%<br>
        <strong>Estimated Intrinsic Value: $${base.intrinsicValue.toFixed(2)} (${baseUpside}% ${baseUpside >= 0 ? "Upside" : "Downside"})</strong>
      `;

      pessimisticDiv.innerHTML = `
        <strong>üòï Pessimistic Scenario</strong><br>
        Growth Rate: ${(userGrowthRate - 0.02) * 100}%<br>
        Future P/E: ${expectedPE - 2}<br>
        Intrinsic Value: <strong>$${pessimistic.intrinsicValue.toFixed(2)} (${pessimisticUpside}% ${pessimisticUpside >= 0 ? "Upside" : "Downside"})</strong>
      `;

      optimisticDiv.innerHTML = `
        <strong>üòÑ Optimistic Scenario</strong><br>
        Growth Rate: ${(userGrowthRate + 0.02) * 100}%<br>
        Future P/E: ${expectedPE + 2}<br>
        Intrinsic Value: <strong>$${optimistic.intrinsicValue.toFixed(2)} (${optimisticUpside}% ${optimisticUpside >= 0 ? "Upside" : "Downside"})</strong>
      `;

      extraDiv.innerHTML = `
        <strong>üì¶ Additional Metrics</strong><br>
        52-Week Range: ${quote.l} ‚Äì ${quote.h}<br>
        Market Cap: $${Number(metrics.metric["marketCapitalization"] || 0).toLocaleString()}<br>
        Dividend Yield: ${metrics.metric["dividendYieldIndicatedAnnual"] || 0}%<br>
        Revenue Growth (1Y): ${(metrics.metric["revenueGrowth"] * 100).toFixed(2)}%<br>
        Profit Margin: ${(metrics.metric["netProfitMarginAnnual"] * 100).toFixed(2)}%<br>
        ROE: ${(metrics.metric["roeAnnual"] * 100).toFixed(2)}%<br>
        Debt/Equity: ${metrics.metric["debtEquityRatioAnnual"]}<br>
        EV/EBITDA: ${metrics.metric["evToEbitdaAnnual"]}<br>
        P/S: ${metrics.metric["priceToSalesAnnual"]}<br>
        P/B: ${metrics.metric["priceToBookAnnual"]}
      `;

      mathDiv.textContent = `Valuation Formula:
Future EPS = EPS √ó (1 + Growth Rate)^t
Present Value = Future EPS / (1 + Discount Rate)^t for t = 1 to ${years}
Terminal Value = EPS in Year 5 √ó Future P/E
Discounted Terminal = Terminal Value / (1 + Discount Rate)^${years}
Sum of all discounted values = Intrinsic Value`;
    } catch (error) {
      resultDiv.innerHTML = "‚ö†Ô∏è Error fetching data. Please check inputs and try again.";
      console.error(error);
    }
  }
</script>
