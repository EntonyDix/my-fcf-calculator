<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intrinsic Value Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    h1 { text-align: center; }
    input, button { margin: 8px 0; padding: 10px; width: 100%; }
    .output { background: #fff; padding: 12px; border-radius: 6px; margin-top: 10px; font-size: 14px; }
    .math { font-family: monospace; background: #eee; padding: 10px; border-radius: 6px; margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>üìä Intrinsic Value Calculator</h1>

  <label for="symbol">Stock Symbol:</label>
  <input type="text" id="symbol" placeholder="e.g., AMZN">

  <label for="growth">Estimated Annual Growth Rate (%):</label>
  <input type="number" id="growth" placeholder="e.g., 15">

  <label for="pe">Expected Future P/E Ratio:</label>
  <input type="number" id="pe" placeholder="e.g., 20">

  <button onclick="calculateIntrinsicValue()">Calculate</button>
  <div class="output" id="result"></div>
  <div class="math" id="math"></div>

  <script>
    const API_KEY = "d0kuab9r01qhb02558rgd0kuab9r01qhb02558s0";

    async function calculateIntrinsicValue() {
      const symbol = document.getElementById("symbol").value.toUpperCase();
      const growthRate = parseFloat(document.getElementById("growth").value) / 100;
      const expectedPE = parseFloat(document.getElementById("pe").value);
      const discountRate = 0.10;
      const years = 5;

      const resultDiv = document.getElementById("result");
      const mathDiv = document.getElementById("math");
      let mathText = "";

      try {
        const [profileRes, quoteRes, metricsRes] = await Promise.all([
          fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${API_KEY}`),
          fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`),
          fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${API_KEY}`)
        ]);

        const profile = await profileRes.json();
        const quote = await quoteRes.json();
        const metrics = await metricsRes.json();

        const eps = metrics.metric["epsTTM"] || 0;
        const price = quote.c || 0;
        const currentPE = eps > 0 ? (price / eps).toFixed(2) : "N/A";
        const growth = isNaN(growthRate) ? 0.08 : growthRate;
        const peRatio = isNaN(expectedPE) ? 15 : expectedPE;

        let intrinsicValue = 0;

        // DCF for 5 years
        for (let t = 1; t <= years; t++) {
          const futureEPS = eps * Math.pow(1 + growth, t);
          const discountedEPS = futureEPS / Math.pow(1 + discountRate, t);
          intrinsicValue += discountedEPS;
          mathText += `Year ${t}: EPS = ${eps.toFixed(2)} √ó (1 + ${growth.toFixed(2)})^${t} = ${futureEPS.toFixed(2)} ‚Üí PV = ${discountedEPS.toFixed(2)}\n`;
        }

        // Terminal Value via P/E method
        const epsYear5 = eps * Math.pow(1 + growth, years);
        const terminalValue = epsYear5 * peRatio;
        const discountedTerminal = terminalValue / Math.pow(1 + discountRate, years);
        intrinsicValue += discountedTerminal;

        mathText += `\nTerminal Value (Year 5 EPS √ó Future P/E): ${epsYear5.toFixed(2)} √ó ${peRatio} = ${terminalValue.toFixed(2)}\n`;
        mathText += `Discounted Terminal Value: ${terminalValue.toFixed(2)} / (1 + ${discountRate})^${years} = ${discountedTerminal.toFixed(2)}\n`;

        resultDiv.innerHTML = `
          <strong>${profile.name || symbol}</strong><br>
          EPS (TTM): $${eps.toFixed(2)}<br>
          Current Price: $${price.toFixed(2)}<br>
          Current P/E: ${currentPE}<br>
          Expected Future P/E: ${peRatio}<br>
          Growth Rate: ${(growth * 100).toFixed(2)}%<br>
          Discount Rate: ${(discountRate * 100).toFixed(2)}%<br>
          <strong>Estimated Intrinsic Value: $${intrinsicValue.toFixed(2)}</strong>
        `;

        mathDiv.textContent = mathText;
      } catch (error) {
        resultDiv.innerHTML = "‚ö†Ô∏è Error fetching data. Check your inputs or try again later.";
        console.error(error);
      }
    }
  </script>
</body>
</html>
