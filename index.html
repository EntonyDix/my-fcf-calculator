<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Intrinsic Value Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 1000px; margin: 20px auto; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    h1 { text-align: center; }
    input, button { margin: 8px 0; padding: 10px; width: 100%; }
    .scenarios { display: flex; gap: 20px; margin-top: 20px; }
    .output, .math { background: #fff; padding: 12px; border-radius: 6px; font-size: 14px; margin-top: 10px; flex: 1; }
    .math { font-family: monospace; background: #eee; white-space: pre-wrap; }
    .pessimistic { color: red; }
    .optimistic { color: green; }
  </style>
</head>
<body>
  <h1>üìä Intrinsic Value Calculator</h1>

  <label for="symbol">Stock Symbol:</label>
  <input type="text" id="symbol" placeholder="e.g., AAPL">

  <label for="growth">Estimated Annual Growth Rate (%):</label>
  <input type="number" id="growth" placeholder="e.g., 10">

  <label for="pe">Expected Future P/E Ratio:</label>
  <input type="number" id="pe" placeholder="e.g., 20">

  <label for="discount">Discount Rate (%):</label>
  <input type="number" id="discount" placeholder="e.g., 10">

  <button onclick="calculate()">Calculate</button>
  <div id="result" class="output"></div>
  <div class="scenarios">
    <div id="pessimistic" class="output pessimistic"></div>
    <div id="optimistic" class="output optimistic"></div>
  </div>
  <div id="math" class="math"></div>

  <script>
    const API_KEY = "d0kuab9r01qhb02558rgd0kuab9r01qhb02558s0";

    async function calculate() {
      const symbol = document.getElementById("symbol").value.toUpperCase();
      const growthRate = parseFloat(document.getElementById("growth").value) / 100;
      const expectedPE = parseFloat(document.getElementById("pe").value);
      const discountRate = parseFloat(document.getElementById("discount").value) / 100;
      const years = 5;

      const resultDiv = document.getElementById("result");
      const pessimisticDiv = document.getElementById("pessimistic");
      const optimisticDiv = document.getElementById("optimistic");
      const mathDiv = document.getElementById("math");
      let mathText = "";

      try {
        const [profileRes, quoteRes, metricsRes] = await Promise.all([
          fetch(`https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${API_KEY}`),
          fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEY}`),
          fetch(`https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${API_KEY}`)
        ]);

        const profile = await profileRes.json();
        const quote = await quoteRes.json();
        const metrics = await metricsRes.json();

        const eps = metrics.metric["epsTTM"] || 0;
        const price = quote.c || 0;
        const currentPE = eps > 0 ? (price / eps).toFixed(2) : "N/A";

        // Valuation function
        function calculateVal(eps, gr, pe, dr) {
          let value = 0;
          for (let t = 1; t <= years; t++) {
            const futureEPS = eps * Math.pow(1 + gr, t);
            const discounted = futureEPS / Math.pow(1 + dr, t);
            value += discounted;
          }
          const epsYear5 = eps * Math.pow(1 + gr, years);
          const terminal = epsYear5 * pe;
          const discountedTerminal = terminal / Math.pow(1 + dr, years);
          value += discountedTerminal;
          return { value, terminal };
        }

        const base = calculateVal(eps, growthRate, expectedPE, discountRate);
        const pessimistic = calculateVal(eps, growthRate - 0.02, expectedPE - 2, discountRate);
        const optimistic = calculateVal(eps, growthRate + 0.02, expectedPE + 2, discountRate);

        const upside = price > 0 ? ((base.value - price) / price * 100).toFixed(2) : "N/A";

        resultDiv.innerHTML = `
          <strong>${profile.name || symbol}</strong><br>
          EPS (TTM): $${eps.toFixed(2)}<br>
          Current Price: $${price.toFixed(2)}<br>
          Current P/E: ${currentPE}<br>
          Expected Future P/E: ${expectedPE}<br>
          Growth Rate: ${(growthRate * 100).toFixed(2)}%<br>
          Discount Rate: ${(discountRate * 100).toFixed(2)}%<br>
          <strong>Estimated Intrinsic Value: $${base.value.toFixed(2)} (${upside}% ${upside >= 0 ? 'Upside' : 'Downside'})</strong>
        `;

        pessimisticDiv.innerHTML = `
          <strong>üòï Pessimistic Scenario</strong><br>
          Growth Rate: ${(growthRate - 0.02) * 100}%<br>
          Future P/E: ${expectedPE - 2}<br>
          Intrinsic Value: <strong>$${pessimistic.value.toFixed(2)}</strong>
        `;

        optimisticDiv.innerHTML = `
          <strong>üòÑ Optimistic Scenario</strong><br>
          Growth Rate: ${(growthRate + 0.02) * 100}%<br>
          Future P/E: ${expectedPE + 2}<br>
          Intrinsic Value: <strong>$${optimistic.value.toFixed(2)}</strong>
        `;

        mathText = `Valuation Formula:\nEPS √ó (1 + Growth Rate)^t / (1 + Discount Rate)^t for t = 1 to 5\nTerminal = EPS in Year 5 √ó Future P/E, discounted\n`;

        mathDiv.textContent = mathText;

      } catch (err) {
        resultDiv.innerHTML = "‚ö†Ô∏è Error fetching data. Check your inputs or try again later.";
        console.error(err);
      }
    }
  </script>
</body>
</html>
