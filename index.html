<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intrinsic Value Calculator</title>
  <style>
    body {
      font-family: Arial;
      margin: 40px auto;
      max-width: 600px;
      background: #fafafa;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: bold;
    }
    input, button {
      width: 100%;
      padding: 8px;
      margin-top: .25em;
      font-size: 1em;
    }
    button {
      margin-top: 1em;
      background: #007acc;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #005fa3;
    }
    #result {
      margin-top: 1.5em;
      padding: 1em;
      background: #e0ffe0;
      border-radius: 4px;
    }
    #debug {
      margin-top: 1em;
      padding: 1em;
      background: #fff3cd;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 200px;
      overflow: auto;
    }
  </style>
</head>
<body>
  <h2>üìà Intrinsic Value Calculator</h2>

  <label for="ticker">Ticker</label>
  <input id="ticker" placeholder="e.g. AAPL">

  <label for="growth">Est. Growth Rate (%)</label>
  <input id="growth" type="number" placeholder="e.g. 10">

  <label for="pe">Future PE Ratio</label>
  <input id="pe" type="number" placeholder="e.g. 15">

  <label for="discount">Discount Rate (%)</label>
  <input id="discount" type="number" placeholder="e.g. 8">

  <label for="years">Forecast Years</label>
  <input id="years" type="number" value="5">

  <button onclick="calculate()">Calculate</button>

  <div id="result">üí¨ Results will appear here.</div>
  <div id="debug" hidden>üêû Debug output</div>

  <script>
    const apiKey = "d0kuab9r01qhb02558rgd0kuab9r01qhb02558s0";

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Network error: ${res.status}`);
      return res.json();
    }

    function parseNum(v) {
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }

    async function fetchFCF(sym) {
      // Try annual cash-flow first
      try {
        const cfUrl = `https://finnhub.io/api/v1/stock/cash-flow?symbol=${sym}&period=annual&token=${apiKey}`;
        const cf = await fetchJSON(cfUrl);
        const val = parseNum(cf.series?.annual?.[0]?.freeCashFlow);
        if (val !== null) {
          return { value: val, label: "Free Cash Flow (Annual)" };
        }
      } catch {}

      // Fallback to TTM metrics
      const mUrl = `https://finnhub.io/api/v1/stock/metric?symbol=${sym}&metric=all&token=${apiKey}`;
      const md = await fetchJSON(mUrl);
      const cands = {
        "Free Cash Flow (TTM)": parseNum(md.metric.freeCashFlowTTM),
        "Net Income (TTM)"     : parseNum(md.metric.netIncomeTTM),
        "EBITDA (TTM)"         : parseNum(md.metric.ebitdaTTM)
      };
      for (let [label, val] of Object.entries(cands)) {
        if (val !== null) return { value: val, label };
      }
      throw new Error("No usable metrics found");
    }

    async function calculate() {
      const t = document.getElementById("ticker").value.trim().toUpperCase();
      const g = parseNum(document.getElementById("growth").value) / 100;
      const p = parseNum(document.getElementById("pe").value);
      const d = parseNum(document.getElementById("discount").value) / 100;
      const n = parseInt(document.getElementById("years").value, 10);
      const res = document.getElementById("result");
      const dbg = document.getElementById("debug");
      dbg.hidden = true;
      res.textContent = "‚è≥ Fetching‚Ä¶";

      if (!t) {
        res.textContent = "‚ö†Ô∏è Please enter a ticker.";
        return;
      }

      try {
        const { value, label } = await fetchFCF(t);
        let fcf = value, pv = 0;
        for (let i = 1; i <= n; i++) {
          fcf *= 1 + g;
          pv += fcf / Math.pow(1 + d, i);
        }
        const term = (fcf * p) / Math.pow(1 + d, n);
        const iv = pv + term;

        res.innerHTML = `
          ‚úÖ <strong>${t}</strong><br>
          üîç Metric Used: <em>${label}</em><br>
          üí∞ Intrinsic Value: <strong>$${(iv / 1e9).toFixed(2)}B</strong>
        `;
      } catch (err) {
        res.textContent = "‚ö†Ô∏è " + err.message;
        dbg.textContent = err.stack;
        dbg.hidden = false;
      }
    }
  </script>
</body>
</html>
